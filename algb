#!/usr/bin/env sh
if [ $# -lt 1 ]; then
  echo "Usage: ./algb <file.mog> [args...]"
  exit 1
fi

MOG_FILE="$1"
shift

BUN_EXE=$(command -v bun)
LLC="/opt/homebrew/opt/llvm/bin/llc"
CLANG=$(command -v clang)
RUNTIME="./build/runtime.a"

if [ ! -f "$MOG_FILE" ]; then
  echo "Error: File not found: $MOG_FILE"
  exit 1
fi

BASENAME=$(basename "$MOG_FILE" .mog)
BUILD_DIR="./build"
LL_FILE="$BUILD_DIR/temp.ll"
O_FILE="$BUILD_DIR/temp.o"
EXE_FILE="$BASENAME"

echo "Compiling $MOG_FILE..."
$BUN_EXE ./compile "$MOG_FILE" > /dev/null 2>&1
if [ $? -ne 0 ]; then
  exit 1
fi

echo "Building object file..."
$LLC -filetype=obj "$LL_FILE" -o "$O_FILE"

echo "Linking executable..."
$CLANG "$O_FILE" "$RUNTIME" -o "$EXE_FILE" 2>&1 | grep -v "no platform load command"

echo "Running $EXE_FILE..."
./"$EXE_FILE" "$@"
echo "Exit code: $?"